# Ralph Wiggum Workflow (Project Prompt)

Goal: work through open issues with short, safe iterations. The agent chooses the next task each run. Produce working code with small commits.

Rules:
- Pick exactly one issue per run, chosen by you from ralph/plan.md.
- Prioritize risky work first: safety/security changes, architectural decisions, integration points.
- Keep the change minimal and focused.
- Leave the repo in a clean state.
- Update ralph/progress.txt with: task completed, key decisions, files changed, blockers/notes.
- If there are no relevant tests, say so in progress.
- Use model size based on task scope: medium for small/perf tweaks, high for safety/security changes, extra for large refactors.
- Default mapping: medium=gpt-5.1-codex-mini, high=gpt-5.3-codex, extra=gpt-5.1-codex-max (override with env vars).
- Reasoning effort mapping: medium=medium, high=high, extra=xhigh (override with env vars).
- This is production-quality code; avoid shortcuts and preserve behavior.

Required structure for each run:
1) Restate the chosen issue and acceptance criteria.
2) Make the smallest change that meets the criteria.
3) Run the most relevant tests or explain why not (types/tests/lint if applicable).
4) Summarize the change, commit it, and update progress.
5) Stop.

Finish the response with the literal line:
COMPLETE

# Issue Plan (ordered)

1. #37 Proxy: Harden run_shell Validation (Allowlist/Denylist + No-Network By Default)
2. #38 Proxy: Gate Network Tools (webfetch/web_search) Behind Explicit Flag
3. #36 Proxy: Tighten Path Safety (Block Absolute Paths, Reduce Sensitive False Positives)
4. #32 Proxy: Enforce Single-Step Tool Calling For Mutations (Confirmation Boundary)
5. #34 Proxy: Stop Inferring filePath For Mutation Tools (No Heuristic Mutations)
6. #35 Proxy: Bound Raw tool_calls Count (Apply Same Limits As Planner Actions)
7. #33 Proxy: Make too_many_actions Recoverable (Truncate Or Re-Ask Planner)

8. #20 Reduce extra chat-history round trips in proxy
9. #21 Reduce planner retry round trips
10. #22 Cache tool prompt and avoid repeated message conversion
11. #23 Optimize context token estimation loops
12. #24 Stream parser: reduce string churn and buffering
13. #25 Run shell tool: avoid buffering full stdout/stderr

14. #26 Split proxy handler for maintainability
15. #30 Split tool output parsing utilities
16. #27 Split GLMClient into focused modules
17. #28 Split tool-call inference helpers
18. #29 Split CLI into commands and login helpers
19. #31 Split web wrapper tools module

2026-02-06
- Initialized workflow files.
- Added Codex CLI hooks to ralph scripts (CODEX_BIN/CODEX_MODEL/CODEX_PROMPT_FLAG).
- Added ralph/current-issue.txt support and a ralph-run-all script with model selection.
- Added model_reasoning_effort wiring and defaults for effort tiers.
- Updated Ralph prompt to enforce agent-picked task, risk priority, quality bar, and commit-per-iteration.
- Simplified ralph-run-all to an AFK loop with fixed iterations and effort defaults.
- #37: Hardened proxy run_shell validation with allowlist/denylist + network disabled by default (override via PROXY_ALLOW_NETWORK=1). Tests: npm --prefix ts_glm test.
  Files: ts_glm/src/proxy/constants.ts, ts_glm/src/proxy/handler.ts, ts_glm/src/proxy/tools/shellSafety.ts, ts_glm/tests/shell-safety.test.ts.
- #38: Gated network tools (webfetch/web_search) behind PROXY_ALLOW_WEB_SEARCH=1 (filtered from tool prompt + blocked tool calls when disabled). Tests: npm --prefix ts_glm test.
  Files: ts_glm/src/proxy/constants.ts, ts_glm/src/proxy/handler.ts, ts_glm/src/proxy/tools/registry.ts, ts_glm/tests/network-tools.test.ts.
- #36: Tightened proxy path safety by blocking absolute paths and reducing sensitive-path false positives (allow .env.example/.env.sample/.env.template/.env.dist; avoid matching "monkey"/"hockey" via overly-broad key substring). Tests: npm --prefix ts_glm test.
  Files: ts_glm/src/proxy/handler.ts, ts_glm/src/proxy/tools/infer.ts, ts_glm/src/proxy/tools/pathSafety.ts, ts_glm/tests/path-safety.test.ts.
- #32: Enforced a confirmation boundary for mutation tools by truncating planner outputs to a single action whenever a mutation tool appears (prompt guidance + server-side guard). Tests: npm --prefix ts_glm test.
  Files: ts_glm/src/proxy/handler.ts, ts_glm/src/proxy/messages.ts, ts_glm/tests/mutation-boundary.test.ts.
